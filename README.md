## Расчёт стоимости портфеля при реализации простой инвестиционной стратегии  
*Дальнейшее развитие [Market-Data-Aggregation](https://github.com/Dmitryfrombigcity/Market-Data-Aggregation)*.    

<img width="1920" height="1080" alt="Screenshot from 2025-12-01 00-38-39" src="https://github.com/user-attachments/assets/9643768b-841e-4764-a0ec-9d96485c30e1" />

<img width="1920" height="1080" alt="Screenshot from 2025-12-01 00-38-34" src="https://github.com/user-attachments/assets/d8a1e95b-ad43-49e7-8851-8cc62f51d099" />

## Основная идея
Ежемесячная покупка акций на фиксированную сумму, а также вложение дивидендов в покупку акций.

## Основные условия
- Покупка акций совершается в определённый день месяца.
- Покупка на дивиденды совершается через определённый промежуток времени после их объявления.

## Настройки
Изначальные условия задаются в файле `.env`.  
Большинство из них имеют значения по умолчанию и валидируются с помощью [Pydantic](https://docs.pydantic.dev/).  

### Пример файла `.env`
```
DB_HOST=localhost
POSTGRES_PORT=5432
DB_USER=user
DB_PASS=password
DB_NAME=aggregation

POOL_MAX_SIZE=15                     # Максимальный размер пула соединений PostgreSQL (по умолчанию 50)
TCPConnectorLimit=100                # Максимальный размер пула соединений aiohttp (по умолчанию 100)
SERVER_PORT=8050                     # Номер порта сервера Flask (по умолчанию 8050)

MONTHLY_INVESTMENTS=2000             # Ежемесячный платёж (по умолчанию 1000, больше 0)
DIVIDENDS_PURCHASE_DAY_OFFSET=2      # Промежуток, через который покупаются акции на дивиденты
                                     # (по умолчанию 8, от 0 до 28)
MONTHLY_PURCHASE_DAY=1               # День месяца, в который регулярно покупаются акции
                                     # (по умолчанию 1, от 1 до 28)
LIMIT_OF_DAYS_FOR_PRICE_SEARCH=28    # Максимальное количество дней без торгов по акции, при превышении считается,
                                     # что акции сняты с торгов (по умолчанию 28, от 1 до 28)

BUNCH_OF_TICKERS=SBER,LKOH           # Набор акций (по умолчанию SBER, LKOH)
```
## Запуск проекта
Проект использует [Docker](https://www.docker.com/).  
Происходит сбор информации с биржи [MOEX](https://www.moex.com/) с помощью [AIOHTTP](https://docs.aiohttp.org/en/stable/).  

## Обработка данных
Создаются две таблицы:  
- **results_trades** — с результатами регулярных торгов.
- **dividends** — с выплатами дивидендов.  
Таблицы создаются при первом запуске, а при последующих проверяется наличие новых данных и их обновление.  
При любой ошибке во время сетевых операций таблица откатывается к предыдущему значению.

## Визуализация данных
Отображение данных производится в окне браузера с помощью [Plotly Dash](https://dash.plotly.com/). Интерфейс интуитивно понятен.  
Во время запроса создаётся динамическая таблица со следующими полями(вкладка **"Grid"**):  
- **date** — дата.
- **ticker** — акция.
- **expenses** — сумма расходов на данную дату.
- **shares** — количество акций на данную дату.
- **capitalization** — капитализация на данную дату.
- **price** — биржевая цена акции на данную дату.
- **monthly_balance** — остаток средств на данную дату.  
*Если после покупки акций остаются средства, они переносятся на следующую покупку.*  

## Логирование
Вывод большинства ошибок подавляется, и выводится лишь сообщение о том, что произошла ошибка.  
При этом подробный отчёт записывается в `logs/logging.txt` с помощью [Loguru](https://loguru.readthedocs.io/en/stable/).

## Запуск программы
```
docker compose -f launch.yml up -d
```
## Для запуска визуализации наберите в браузере
```
http://localhost:8050
```
## Завершение программы
```
 docker compose -f launch.yml down
```
## Тестирование
Для тестирования сетевых соединений применяется **`Mocking`**.  
Для проверки работы с базой данных используется тестовая база с предопределенным набором данных.  
Запуск тестов происходит при каждом push с помощью GitHub Actions.  

## Используемые технологии:
- *Python*
- *asyncio*
- *AIOHTTP*
- *Pydantic*
- *pydantic-settings*
- *PostgreSQL*
- *psycopg*
- *psycopg-pool*
- *SQLAlchemy*
- *Alembic*
- *Repository and Unit of Work Patterns*
- *Pytest*
- *pytest-dotenv*
- *pytest-mock*
- *pytest-asyncio*
- *Mypy*
- *Docker*
- *Dash*
- *dash-ag-grid*
- *dash-bootstrap-components*
- *Pandas*
- *Loguru*
## Disclaimer
Программа не учитывает некоторые особенности работы биржи, например **stock split**.  
При странном поведении графика всегда можно проверить данные на вкладке **Grid**.


